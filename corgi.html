
<html>
<head>
	<style type="text/css">
		#loadingBar {
			position: fixed; /* or absolute */
		  	top: 50%;
		  	left: 50%;
		}
	</style>
</head>
  <body>
    <script type="module">
      import * as THREE from "https://unpkg.com/three@0.125.2/build/three.module.js";
      import { OBJLoader } from "https://unpkg.com/three@0.125.2/examples/jsm/loaders/OBJLoader.js";
      import { MTLLoader } from "https://unpkg.com/three@0.125.2/examples/jsm/loaders/MTLLoader.js";
      import { TrackballControls } from "https://unpkg.com/three@0.125.2/examples/jsm/controls/TrackballControls.js";

      	let NUM_FRAMES = 63;
		let MODEL_PATH = 'models/a_corgi_playing_with_a_ball/';
		let ALBEDO_FORMAT = '.jpg';

		let camera, scene, renderer, controls;
		let currFrameIndex = 0;
		let currTime = Date.now();

		init();

		var frameIndexToObject = {};

		createFrames().then(animate());

		async function createFrames() {
			const textureLoader = new THREE.TextureLoader();
			const objLoader = new OBJLoader();

			for (let frameIndex = 0; frameIndex < NUM_FRAMES; frameIndex++) {
				// const [ texture, obj ] = await Promise.all( [
				// 	textureLoader.loadAsync(MODEL_PATH + frameIndex + '_albedo' + ALBEDO_FORMAT),
				// 	objLoader.loadAsync(MODEL_PATH + frameIndex + '_mesh.obj'),
				// ] );

				// obj.name = 'loaded_mesh';
				// obj.children[0].material.map = texture;
				// obj.children[0].geometry.computeVertexNormals();

				// frameIndexToObject[frameIndex] = obj;

				// console.log(frameIndexToObject);


				Promise.all([
					textureLoader.loadAsync(MODEL_PATH + frameIndex + '_albedo' + ALBEDO_FORMAT),
					objLoader.loadAsync(MODEL_PATH + frameIndex + '_mesh.obj'),
				]).then((values) => {
						var texture = values[0];
						var obj = values[1];
						//let [texture, obj] = values[0], values[1];						

						obj.name = 'loaded_mesh';
						obj.children[0].material.map = texture;
						obj.children[0].geometry.computeVertexNormals();

						frameIndexToObject[frameIndex] = obj;

						console.log(frameIndexToObject);
				});
			}
		}



		function init() {


			camera = new THREE.PerspectiveCamera( 45, window.innerWidth / window.innerHeight, 1, 200 );
			camera.position.z = 5;

			// scene

			scene = new THREE.Scene();
			scene.background = new THREE.Color( 0xffffff );

			const ambientLight = new THREE.AmbientLight( 0xcccccc, 0.4 );
			scene.add( ambientLight );

			const pointLight = new THREE.PointLight( 0xffffff, 0.8 );
			camera.add( pointLight );
			scene.add( camera );


			renderer = new THREE.WebGLRenderer();
			renderer.setPixelRatio( window.devicePixelRatio );
			renderer.setSize( window.innerWidth, window.innerHeight );
			document.body.appendChild( renderer.domElement );


			controls = new TrackballControls( camera, renderer.domElement );

			controls.rotateSpeed = 1.5;
			controls.zoomSpeed = 1.2;
			controls.panSpeed = 1.2;

			controls.keys = [ 'KeyA', 'KeyS', 'KeyD' ];


			window.addEventListener( 'resize', onWindowResize );

		}

		function onWindowResize() {

			camera.aspect = window.innerWidth / window.innerHeight;
			camera.updateProjectionMatrix();

			renderer.setSize( window.innerWidth, window.innerHeight );

		}

		function animate() {
			requestAnimationFrame( animate );
			controls.update();

			if (Object.keys(frameIndexToObject).length == NUM_FRAMES) 
			{
				var element = document.getElementById('loadingBar');
				if (element != null) element.remove();
			}

			if ((Date.now() - currTime > 62.5) && (Object.keys(frameIndexToObject).length == NUM_FRAMES)) {
				currTime = Date.now();

				scene.remove(scene.getObjectByName('loaded_mesh'));
				scene.add(frameIndexToObject[currFrameIndex]);
				currFrameIndex++;
				if (currFrameIndex >= NUM_FRAMES) currFrameIndex = 0;

			}

			renderer.render( scene, camera );

		}




    </script>
    <div id="loadingBar">Loading...</div>
  </body>
</html>


